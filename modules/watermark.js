// Ê∞¥Âç∞Â§ÑÁêÜÊ®°Âùó
window.ImageWatermark = {
    container: null,
    currentImage: null,
    watermarkImage: null,
    canvas: null,
    ctx: null,
    isTextWatermarkMode: false,
    
    init: function(container) {
        this.container = container;
        this.render();
        this.setupEventListeners();
    },
    
    render: function() {
        this.container.innerHTML = `
            <div class="watermark-workspace">
                <!-- ÂõæÂÉè‰∏ä‰º†Âå∫Âüü -->
                <div class="upload-section">
                    <div class="upload-grid">
                        <div class="upload-area" id="main-upload-area">
                            <div class="upload-content">
                                <div class="upload-icon">üñºÔ∏è</div>
                                <h3>ÈÄâÊã©‰∏ªÂõæÂÉè</h3>
                                <p>Ë¶ÅÊ∑ªÂä†Ê∞¥Âç∞ÁöÑÂõæÂÉè</p>
                                <input type="file" id="main-image-input" accept="image/*" style="display: none;">
                                <button class="upload-btn" onclick="document.getElementById('main-image-input').click()">
                                    ÈÄâÊã©Êñá‰ª∂
                                </button>
                            </div>
                        </div>
                        
                        <div class="upload-area" id="watermark-upload-area">
                            <div class="upload-content">
                                <div class="upload-icon">üíß</div>
                                <h3>ÈÄâÊã©Ê∞¥Âç∞ÂõæÂÉè</h3>
                                <p>Êàñ‰ΩøÁî®È¢ÑËÆæÊ∞¥Âç∞</p>
                                <input type="file" id="watermark-image-input" accept="image/*" style="display: none;">
                                <button class="upload-btn" onclick="document.getElementById('watermark-image-input').click()">
                                    ÈÄâÊã©Êñá‰ª∂
                                </button>
                                <div class="preset-watermarks">
                                    <button class="preset-btn" data-watermark="text">ÊñáÂ≠óÊ∞¥Âç∞</button>
                                    <button class="preset-btn" data-watermark="logo">LogoÊ∞¥Âç∞</button>
                                </div>

                            </div>
                        </div>
                    </div>

                    <!-- ÂºÄÂßãÂ§ÑÁêÜÊåâÈíÆ -->
                    <div class="start-processing-section" style="text-align: center; margin-top: 2rem;">
                        <button class="start-processing-btn" id="start-processing-btn" style="display: none;">
                            ÂºÄÂßãÊ∞¥Âç∞Â§ÑÁêÜ
                        </button>
                        <p class="processing-hint" style="margin-top: 1rem; color: var(--text-muted); font-size: 0.9rem;">
                            ËØ∑ÈÄâÊã©‰∏ªÂõæÂÉèÂíåÊ∞¥Âç∞ÂõæÂÉèÔºàÊàñÈÄâÊã©È¢ÑËÆæÊ∞¥Âç∞ÔºâÂêéÂºÄÂßãÂ§ÑÁêÜ
                        </p>
                    </div>
                </div>
                
                <!-- Ê∞¥Âç∞Â§ÑÁêÜÂå∫Âüü -->
                <div class="processing-section d-none" id="processing-section">
                    <!-- ÂõæÂÉèÊòæÁ§∫Âå∫Âüü -->
                    <div class="image-display">
                        <div class="image-container">
                            <h4>ÂéüÂßãÂõæÂÉè</h4>
                            <img id="original-image" class="preview-image" alt="ÂéüÂßãÂõæÂÉè">
                        </div>
                        <div class="image-container">
                            <h4>Ê∞¥Âç∞È¢ÑËßà</h4>
                            <canvas id="result-canvas" class="preview-image"></canvas>
                        </div>
                    </div>
                    
                    <!-- Ê∞¥Âç∞ÊéßÂà∂Èù¢Êùø -->
                    <div class="watermark-controls">
                        <div class="control-tabs">
                            <button class="tab-btn active" data-tab="position">‰ΩçÁΩÆË∞ÉËäÇ</button>
                            <button class="tab-btn" data-tab="appearance">Â§ñËßÇËÆæÁΩÆ</button>
                            <button class="tab-btn" data-tab="text">ÊñáÂ≠óÊ∞¥Âç∞</button>
                        </div>
                        
                        <!-- ‰ΩçÁΩÆË∞ÉËäÇ -->
                        <div class="tab-content active" id="position-tab">
                            <div class="position-grid">
                                <button class="position-btn" data-position="top-left">Â∑¶‰∏ä</button>
                                <button class="position-btn" data-position="top-center">‰∏ä‰∏≠</button>
                                <button class="position-btn" data-position="top-right">Âè≥‰∏ä</button>
                                <button class="position-btn" data-position="center-left">Â∑¶‰∏≠</button>
                                <button class="position-btn active" data-position="center">Â±Ö‰∏≠</button>
                                <button class="position-btn" data-position="center-right">Âè≥‰∏≠</button>
                                <button class="position-btn" data-position="bottom-left">Â∑¶‰∏ã</button>
                                <button class="position-btn" data-position="bottom-center">‰∏ã‰∏≠</button>
                                <button class="position-btn" data-position="bottom-right">Âè≥‰∏ã</button>
                            </div>
                            <div class="control-group">
                                <label>XÂÅèÁßª:</label>
                                <input type="range" id="x-offset" min="-100" max="100" value="0">
                                <span id="x-offset-value">0px</span>
                            </div>
                            <div class="control-group">
                                <label>YÂÅèÁßª:</label>
                                <input type="range" id="y-offset" min="-100" max="100" value="0">
                                <span id="y-offset-value">0px</span>
                            </div>
                        </div>
                        
                        <!-- Â§ñËßÇËÆæÁΩÆ -->
                        <div class="tab-content" id="appearance-tab">
                            <div class="control-group">
                                <label>ÈÄèÊòéÂ∫¶:</label>
                                <input type="range" id="opacity" min="10" max="100" value="50">
                                <span id="opacity-value">50%</span>
                            </div>
                            <div class="control-group">
                                <label>Áº©Êîæ:</label>
                                <input type="range" id="scale" min="10" max="200" value="100">
                                <span id="scale-value">100%</span>
                            </div>
                            <div class="control-group">
                                <label>ÊóãËΩ¨:</label>
                                <input type="range" id="rotation" min="0" max="360" value="0">
                                <span id="rotation-value">0¬∞</span>
                            </div>
                            <div class="control-group">
                                <label>Ê∑∑ÂêàÊ®°Âºè:</label>
                                <select id="blend-mode">
                                    <option value="normal">Ê≠£Â∏∏</option>
                                    <option value="multiply">Ê≠£ÁâáÂè†Â∫ï</option>
                                    <option value="screen">Êª§Ëâ≤</option>
                                    <option value="overlay">Âè†Âä†</option>
                                    <option value="soft-light">ÊüîÂÖâ</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- ÊñáÂ≠óÊ∞¥Âç∞ -->
                        <div class="tab-content" id="text-tab">
                            <div class="control-group">
                                <label>Ê∞¥Âç∞ÊñáÂ≠ó:</label>
                                <input type="text" id="watermark-text" placeholder="ËæìÂÖ•Ê∞¥Âç∞ÊñáÂ≠ó" value="WATERMARK">
                            </div>
                            <div class="control-group">
                                <label>Â≠ó‰ΩìÂ§ßÂ∞è:</label>
                                <input type="range" id="font-size" min="12" max="100" value="36">
                                <span id="font-size-value">36px</span>
                            </div>
                            <div class="control-group">
                                <label>Â≠ó‰ΩìÈ¢úËâ≤:</label>
                                <input type="color" id="font-color" value="#ffffff">
                            </div>
                            <div class="control-group">
                                <label>Â≠ó‰ΩìÊ†∑Âºè:</label>
                                <select id="font-family">
                                    <option value="Arial">Arial</option>
                                    <option value="Microsoft YaHei">ÂæÆËΩØÈõÖÈªë</option>
                                    <option value="SimHei">Èªë‰Ωì</option>
                                    <option value="Times New Roman">Times New Roman</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ê∞¥Âç∞Â§ÑÁêÜÊºîÁ§∫ -->
                    <div class="demo-section">
                        <h4>Ê∞¥Âç∞Â§ÑÁêÜËøáÁ®ã</h4>
                        <div class="process-steps">
                            <div class="step-item">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <h5>Âä†ËΩΩÊ∞¥Âç∞</h5>
                                    <p>ÈÄâÊã©ÊàñÂàõÂª∫Ê∞¥Âç∞ÂõæÂÉè</p>
                                </div>
                            </div>
                            <div class="step-item">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <h5>ÈÄèÊòéÂ§ÑÁêÜ</h5>
                                    <p>Ë∞ÉÊï¥Ê∞¥Âç∞ÈÄèÊòéÂ∫¶ÂíåÊ∑∑ÂêàÊ®°Âºè</p>
                                </div>
                            </div>
                            <div class="step-item">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <h5>‰ΩçÁΩÆË∞ÉÊï¥</h5>
                                    <p>ËÆæÁΩÆÊ∞¥Âç∞Âú®ÂõæÂÉè‰∏≠ÁöÑ‰ΩçÁΩÆ</p>
                                </div>
                            </div>
                            <div class="step-item">
                                <div class="step-number">4</div>
                                <div class="step-content">
                                    <h5>ÂêàÊàêËæìÂá∫</h5>
                                    <p>Â∞ÜÊ∞¥Âç∞ÂêàÊàêÂà∞ÂéüÂõæÂÉè‰∏ä</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Êìç‰ΩúÊåâÈíÆ -->
                    <div class="action-buttons">
                        <button class="action-btn secondary" id="preview-btn">È¢ÑËßàÊïàÊûú</button>
                        <button class="action-btn secondary" id="download-btn">‰∏ãËΩΩÁªìÊûú</button>
                        <button class="action-btn primary" id="new-image-btn">Â§ÑÁêÜÊñ∞ÂõæÂÉè</button>
                    </div>
                </div>
            </div>
            
            <style>
                .watermark-workspace {
                    max-width: 1000px;
                    margin: 0 auto;
                }
                
                .upload-grid {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 2rem;
                    margin-bottom: 2rem;
                }
                
                .upload-area {
                    border: 2px dashed var(--border-color);
                    border-radius: 12px;
                    padding: 2rem 1.5rem;
                    text-align: center;
                    transition: all 0.3s ease;
                    cursor: pointer;
                }
                
                .upload-area:hover {
                    border-color: var(--primary-color);
                    background: rgba(102, 126, 234, 0.05);
                }
                
                .upload-icon {
                    font-size: 2.5rem;
                    margin-bottom: 1rem;
                }
                
                .upload-btn {
                    padding: 0.75rem 1.5rem;
                    background: var(--primary-color);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    margin-top: 1rem;
                    margin-bottom: 1rem;
                }

                .upload-btn.secondary {
                    background: var(--background-light);
                    color: var(--text-color);
                    border: 1px solid var(--border-color);
                }

                .upload-area.uploaded {
                    border-color: var(--success-color);
                    background: rgba(40, 167, 69, 0.05);
                }

                .start-processing-btn {
                    padding: 1rem 3rem;
                    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
                    color: white;
                    border: none;
                    border-radius: 12px;
                    cursor: pointer;
                    font-size: 1.1rem;
                    font-weight: 600;
                    transition: all 0.3s ease;
                    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
                }

                .start-processing-btn:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
                }
                
                .preset-watermarks {
                    display: flex;
                    gap: 0.5rem;
                    justify-content: center;
                }
                
                .preset-btn {
                    padding: 0.5rem 1rem;
                    background: var(--background-light);
                    border: 1px solid var(--border-color);
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 0.8rem;
                }
                
                .image-display {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 2rem;
                    margin-bottom: 2rem;
                }
                
                .image-container {
                    text-align: center;
                }
                
                .image-container h4 {
                    margin-bottom: 1rem;
                    color: var(--text-color);
                }
                
                .preview-image {
                    max-width: 100%;
                    max-height: 300px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                }
                
                .watermark-controls {
                    background: var(--background-light);
                    border-radius: 12px;
                    padding: 1.5rem;
                    margin-bottom: 2rem;
                }
                
                .control-tabs {
                    display: flex;
                    margin-bottom: 1.5rem;
                    border-bottom: 1px solid var(--border-color);
                }
                
                .tab-btn {
                    padding: 0.75rem 1.5rem;
                    background: none;
                    border: none;
                    cursor: pointer;
                    border-bottom: 2px solid transparent;
                    transition: all 0.3s ease;
                }
                
                .tab-btn.active {
                    color: var(--primary-color);
                    border-bottom-color: var(--primary-color);
                }
                
                .tab-content {
                    display: none;
                }
                
                .tab-content.active {
                    display: block;
                }
                
                .position-grid {
                    display: grid;
                    grid-template-columns: repeat(3, 1fr);
                    gap: 0.5rem;
                    margin-bottom: 1.5rem;
                    max-width: 300px;
                }
                
                .position-btn {
                    padding: 0.75rem;
                    background: white;
                    border: 1px solid var(--border-color);
                    border-radius: 6px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    font-size: 0.8rem;
                }
                
                .position-btn.active {
                    background: var(--primary-color);
                    color: white;
                    border-color: var(--primary-color);
                }
                
                .control-group {
                    margin-bottom: 1rem;
                    display: flex;
                    align-items: center;
                    gap: 1rem;
                }
                
                .control-group label {
                    min-width: 80px;
                    font-weight: 500;
                }
                
                .control-group input[type="range"] {
                    flex: 1;
                }
                
                .control-group input[type="text"] {
                    flex: 1;
                    padding: 0.5rem;
                    border: 1px solid var(--border-color);
                    border-radius: 6px;
                }
                
                .demo-section {
                    background: white;
                    border-radius: 12px;
                    padding: 1.5rem;
                    margin-bottom: 2rem;
                    border: 1px solid var(--border-color);
                }
                
                .process-steps {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 1rem;
                }
                
                .step-item {
                    display: flex;
                    align-items: center;
                    gap: 1rem;
                    padding: 1rem;
                    background: var(--background-light);
                    border-radius: 8px;
                }
                
                .step-number {
                    width: 30px;
                    height: 30px;
                    background: var(--primary-color);
                    color: white;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: bold;
                    flex-shrink: 0;
                }
                
                .step-content h5 {
                    margin-bottom: 0.25rem;
                    color: var(--text-color);
                }
                
                .step-content p {
                    font-size: 0.85rem;
                    color: var(--text-light);
                    margin: 0;
                }
                
                .action-buttons {
                    display: flex;
                    gap: 1rem;
                    margin-top: 2rem;
                    padding-top: 1.5rem;
                    border-top: 1px solid var(--border-color);
                }
                
                .action-btn {
                    flex: 1;
                    padding: 0.75rem;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    font-weight: 500;
                }
                
                .action-btn.primary {
                    background: var(--primary-color);
                    color: white;
                }
                
                .action-btn.secondary {
                    background: var(--background-light);
                    color: var(--text-color);
                    border: 1px solid var(--border-color);
                }
                
                @media (max-width: 768px) {
                    .upload-grid {
                        grid-template-columns: 1fr;
                    }
                    
                    .image-display {
                        grid-template-columns: 1fr;
                    }
                    
                    .control-group {
                        flex-direction: column;
                        align-items: stretch;
                    }
                    
                    .action-buttons {
                        flex-direction: column;
                    }
                    
                    .process-steps {
                        grid-template-columns: 1fr;
                    }
                }
            </style>
        `;
    },
    
    setupEventListeners: function() {
        // Êñá‰ª∂‰∏ä‰º†
        const mainImageInput = document.getElementById('main-image-input');
        const watermarkImageInput = document.getElementById('watermark-image-input');
        
        mainImageInput.addEventListener('change', (e) => this.handleMainImageUpload(e));
        watermarkImageInput.addEventListener('change', (e) => this.handleWatermarkImageUpload(e));
        
        // Ê†áÁ≠æÈ°µÂàáÊç¢
        const tabBtns = document.querySelectorAll('.tab-btn');
        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => this.switchTab(btn.dataset.tab));
        });
        
        // ‰ΩçÁΩÆÊåâÈíÆ
        const positionBtns = document.querySelectorAll('.position-btn');
        positionBtns.forEach(btn => {
            btn.addEventListener('click', () => this.setPosition(btn.dataset.position));
        });
        
        // È¢ÑËÆæÊ∞¥Âç∞
        const presetBtns = document.querySelectorAll('.preset-btn');
        presetBtns.forEach(btn => {
            btn.addEventListener('click', () => this.usePresetWatermark(btn.dataset.watermark));
        });

        // ÂºÄÂßãÂ§ÑÁêÜÊåâÈíÆ
        const startProcessingBtn = document.getElementById('start-processing-btn');
        if (startProcessingBtn) {
            startProcessingBtn.addEventListener('click', () => this.enterProcessingMode());
        }

        // ÊªëÂùó‰∫ã‰ª∂ÁõëÂê¨Âô®
        this.setupSliders();

        // Êìç‰ΩúÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
        this.setupActionButtons();
    },
    
    handleMainImageUpload: function(event) {
        const file = event.target.files[0];
        if (file) {
            this.loadMainImage(file);
        }
    },
    
    handleWatermarkImageUpload: function(event) {
        const file = event.target.files[0];
        if (file) {
            this.loadWatermarkImage(file);
        }
    },
    
    loadMainImage: function(file) {
        if (!file.type.startsWith('image/')) {
            alert('ËØ∑ÈÄâÊã©ÂõæÂÉèÊñá‰ª∂');
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                this.currentImage = img;
                this.setupCanvas();
                this.checkReadyToProcess();

                if (window.ImageLabUtils) {
                    window.ImageLabUtils.showNotification('‰∏ªÂõæÂÉèÂ∑≤Âä†ËΩΩ', 'success');
                }
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    },
    
    loadWatermarkImage: function(file) {
        if (!file.type.startsWith('image/')) {
            alert('ËØ∑ÈÄâÊã©ÂõæÂÉèÊñá‰ª∂');
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                // Â§ÑÁêÜÊ∞¥Âç∞ËÉåÊôØÈÄèÊòéÂåñ
                this.watermarkImage = this.processWatermarkTransparency(img);
                this.isTextWatermarkMode = false; // Ê∏ÖÈô§ÊñáÂ≠óÊ∞¥Âç∞Ê®°Âºè

                // ÊòæÁ§∫Ê∞¥Âç∞È¢ÑËßà
                this.showWatermarkPreview(this.watermarkImage);

                // Ê£ÄÊü•ÊòØÂê¶ÂèØ‰ª•ËøõÂÖ•Â§ÑÁêÜÁïåÈù¢
                this.checkReadyToProcess();

                if (window.ImageLabUtils) {
                    window.ImageLabUtils.showNotification('Ê∞¥Âç∞ÂõæÂÉèÂ∑≤Âä†ËΩΩ', 'success');
                }
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    },
    
    setupCanvas: function() {
        const originalImage = document.getElementById('original-image');
        const canvas = document.getElementById('result-canvas');
        
        originalImage.src = this.currentImage.src;
        
        this.canvas = canvas;
        this.ctx = canvas.getContext('2d');
        
        // ËÆæÁΩÆÁîªÂ∏ÉÂ∞∫ÂØ∏
        canvas.width = this.currentImage.width;
        canvas.height = this.currentImage.height;
        
        // ÁªòÂà∂ÂéüÂßãÂõæÂÉè
        this.ctx.drawImage(this.currentImage, 0, 0);
    },
    
    checkReadyToProcess: function() {
        // Êõ¥Êñ∞‰∏ä‰º†Âå∫ÂüüÁöÑÁä∂ÊÄÅÊòæÁ§∫
        this.updateUploadStatus();

        // Ê£ÄÊü•ÊòØÂê¶ÂèØ‰ª•ËøõÂÖ•Â§ÑÁêÜÁïåÈù¢
        const canProcess = this.canEnterProcessing();

        if (canProcess) {
            // ÊòæÁ§∫ËøõÂÖ•Â§ÑÁêÜÁïåÈù¢ÁöÑÊåâÈíÆ
            this.showProcessButton();
        } else {
            // ÈöêËóèËøõÂÖ•Â§ÑÁêÜÁïåÈù¢ÁöÑÊåâÈíÆ
            this.hideProcessButton();
        }
    },

    canEnterProcessing: function() {
        // ÂøÖÈ°ªÊúâ‰∏ªÂõæÂÉèÔºåÂπ∂‰∏îÊúâÊ∞¥Âç∞ÂõæÂÉèÊàñÂáÜÂ§á‰ΩøÁî®ÊñáÂ≠óÊ∞¥Âç∞
        return this.currentImage && (this.watermarkImage || this.isTextWatermarkMode);
    },

    updateUploadStatus: function() {
        const mainUploadArea = document.getElementById('main-upload-area');
        const watermarkUploadArea = document.getElementById('watermark-upload-area');

        // Êõ¥Êñ∞‰∏ªÂõæÂÉè‰∏ä‰º†Âå∫ÂüüÁä∂ÊÄÅ
        if (this.currentImage) {
            mainUploadArea.classList.add('uploaded');
            const content = mainUploadArea.querySelector('.upload-content h3');
            if (content) content.textContent = '‚úì ‰∏ªÂõæÂÉèÂ∑≤ÈÄâÊã©';
        } else {
            mainUploadArea.classList.remove('uploaded');
            const content = mainUploadArea.querySelector('.upload-content h3');
            if (content) content.textContent = 'ÈÄâÊã©‰∏ªÂõæÂÉè';
        }

        // Êõ¥Êñ∞Ê∞¥Âç∞‰∏ä‰º†Âå∫ÂüüÁä∂ÊÄÅ
        if (this.watermarkImage) {
            watermarkUploadArea.classList.add('uploaded');
            const content = watermarkUploadArea.querySelector('.upload-content h3');
            if (content) content.textContent = '‚úì Ê∞¥Âç∞ÂõæÂÉèÂ∑≤ÈÄâÊã©';
        } else if (this.isTextWatermarkMode) {
            watermarkUploadArea.classList.add('uploaded');
            const content = watermarkUploadArea.querySelector('.upload-content h3');
            if (content) content.textContent = '‚úì ÊñáÂ≠óÊ∞¥Âç∞Ê®°Âºè';
        } else {
            watermarkUploadArea.classList.remove('uploaded');
            const content = watermarkUploadArea.querySelector('.upload-content h3');
            if (content) content.textContent = 'ÈÄâÊã©Ê∞¥Âç∞ÂõæÂÉè';
        }
    },

    showProcessButton: function() {
        const processBtn = document.getElementById('start-processing-btn');
        if (processBtn) {
            processBtn.style.display = 'block';
        }
    },

    hideProcessButton: function() {
        const processBtn = document.getElementById('start-processing-btn');
        if (processBtn) {
            processBtn.style.display = 'none';
        }
    },

    enterProcessingMode: function() {
        if (!this.canEnterProcessing()) {
            if (window.ImageLabUtils) {
                window.ImageLabUtils.showNotification('ËØ∑ÂÖàÈÄâÊã©‰∏ªÂõæÂÉèÂíåÊ∞¥Âç∞', 'warning');
            }
            return;
        }

        // ËøõÂÖ•Â§ÑÁêÜÁïåÈù¢
        document.querySelector('.upload-section').classList.add('d-none');
        document.getElementById('processing-section').classList.remove('d-none');

        // Â¶ÇÊûúÊòØÊñáÂ≠óÊ∞¥Âç∞Ê®°Âºè‰ΩÜÊ≤°ÊúâÊñáÂ≠óÔºåËÆæÁΩÆÈªòËÆ§ÊñáÂ≠ó
        if (this.isTextWatermarkMode && !this.hasTextWatermark()) {
            const watermarkText = document.getElementById('watermark-text');
            if (watermarkText) {
                watermarkText.value = 'WATERMARK';
            }
        }

        this.updateWatermark();

        if (window.ImageLabUtils) {
            window.ImageLabUtils.showNotification('Â∑≤ËøõÂÖ•Ê∞¥Âç∞Â§ÑÁêÜÁïåÈù¢', 'success');
        }
    },

    hasTextWatermark: function() {
        const watermarkText = document.getElementById('watermark-text');
        return watermarkText && watermarkText.value.trim().length > 0;
    },
    
    switchTab: function(tabName) {
        // Êõ¥Êñ∞Ê†áÁ≠æÊåâÈíÆÁä∂ÊÄÅ
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        
        // Êõ¥Êñ∞Ê†áÁ≠æÂÜÖÂÆπ
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.getElementById(`${tabName}-tab`).classList.add('active');
    },
    
    setPosition: function(position) {
        // Êõ¥Êñ∞‰ΩçÁΩÆÊåâÈíÆÁä∂ÊÄÅ
        document.querySelectorAll('.position-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`[data-position="${position}"]`).classList.add('active');
        
        // Â∫îÁî®Êñ∞‰ΩçÁΩÆ
        this.applyWatermark();
    },
    
    usePresetWatermark: function(type) {
        if (type === 'text') {
            // ÂêØÁî®ÊñáÂ≠óÊ∞¥Âç∞Ê®°Âºè
            this.enableTextWatermarkMode();
        } else if (type === 'logo') {
            // ‰ΩøÁî®È¢ÑËÆælogo
            this.createLogoWatermark();
        }
    },

    enableTextWatermarkMode: function() {
        // ËÆæÁΩÆÊñáÂ≠óÊ∞¥Âç∞Ê®°ÂºèÊ†áÂøó
        this.isTextWatermarkMode = true;
        this.watermarkImage = null; // Ê∏ÖÈô§ÂõæÂÉèÊ∞¥Âç∞

        // Êõ¥Êñ∞Áä∂ÊÄÅ
        this.checkReadyToProcess();

        if (window.ImageLabUtils) {
            window.ImageLabUtils.showNotification('Â∑≤ÂêØÁî®ÊñáÂ≠óÊ∞¥Âç∞Ê®°Âºè', 'info');
        }
    },
    
    createTextWatermark: function() {
        // ÂàõÂª∫ÊñáÂ≠óÊ∞¥Âç∞ÁöÑÂÆûÁé∞
        alert('ÂàõÂª∫ÊñáÂ≠óÊ∞¥Âç∞ÂäüËÉΩ');
    },
    
    createLogoWatermark: function() {
        // ÂàõÂª∫logoÊ∞¥Âç∞ÁöÑÂÆûÁé∞
        alert('ÂàõÂª∫LogoÊ∞¥Âç∞ÂäüËÉΩ');
    },
    
    setupSliders: function() {
        const sliders = [
            { id: 'x-offset', valueId: 'x-offset-value', suffix: 'px' },
            { id: 'y-offset', valueId: 'y-offset-value', suffix: 'px' },
            { id: 'opacity', valueId: 'opacity-value', suffix: '%' },
            { id: 'scale', valueId: 'scale-value', suffix: '%' },
            { id: 'rotation', valueId: 'rotation-value', suffix: '¬∞' },
            { id: 'font-size', valueId: 'font-size-value', suffix: 'px' }
        ];

        sliders.forEach(slider => {
            const sliderElement = document.getElementById(slider.id);
            const valueElement = document.getElementById(slider.valueId);

            if (sliderElement && valueElement) {
                sliderElement.addEventListener('input', () => {
                    valueElement.textContent = sliderElement.value + slider.suffix;
                    this.updateWatermark();
                });
            }
        });

        // ÊñáÂ≠óÊ∞¥Âç∞ËæìÂÖ•Ê°Ü
        const watermarkText = document.getElementById('watermark-text');
        const fontColor = document.getElementById('font-color');
        const fontFamily = document.getElementById('font-family');
        const blendMode = document.getElementById('blend-mode');

        if (watermarkText) {
            watermarkText.addEventListener('input', () => {
                // Ê£ÄÊü•ÊòØÂê¶ÂèØ‰ª•ËøõÂÖ•Â§ÑÁêÜÁïåÈù¢
                this.checkReadyToProcess();
                // Â¶ÇÊûúÂ∑≤ÁªèÂú®Â§ÑÁêÜÁïåÈù¢ÔºåÊõ¥Êñ∞Ê∞¥Âç∞
                if (!document.getElementById('processing-section').classList.contains('d-none')) {
                    this.updateWatermark();
                }
            });
        }

        if (fontColor) {
            fontColor.addEventListener('change', () => this.updateWatermark());
        }

        if (fontFamily) {
            fontFamily.addEventListener('change', () => this.updateWatermark());
        }

        if (blendMode) {
            blendMode.addEventListener('change', () => this.updateWatermark());
        }
    },

    setupActionButtons: function() {
        const previewBtn = document.getElementById('preview-btn');
        const downloadBtn = document.getElementById('download-btn');
        const newImageBtn = document.getElementById('new-image-btn');

        if (previewBtn) {
            previewBtn.addEventListener('click', () => this.previewWatermark());
        }

        if (downloadBtn) {
            downloadBtn.addEventListener('click', () => this.downloadResult());
        }

        if (newImageBtn) {
            newImageBtn.addEventListener('click', () => this.loadNewImage());
        }
    },

    updateWatermark: function() {
        if (!this.currentImage) return;

        // ÈáçÊñ∞ÁªòÂà∂ÂéüÂßãÂõæÂÉè
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        this.ctx.drawImage(this.currentImage, 0, 0);

        // Ê£ÄÊü•ÊòØÂê¶ÊúâÊ∞¥Âç∞ÂõæÂÉèÊàñÊñáÂ≠ó
        const watermarkText = document.getElementById('watermark-text')?.value;

        if (this.watermarkImage) {
            this.applyImageWatermark();
        } else if (watermarkText) {
            this.applyTextWatermark();
        }
    },

    applyImageWatermark: function() {
        if (!this.watermarkImage) return;

        // Ëé∑ÂèñËÆæÁΩÆÂÄº
        const opacity = parseFloat(document.getElementById('opacity')?.value || 50) / 100;
        const scale = parseFloat(document.getElementById('scale')?.value || 100) / 100;
        const rotation = parseFloat(document.getElementById('rotation')?.value || 0);
        const xOffset = parseFloat(document.getElementById('x-offset')?.value || 0);
        const yOffset = parseFloat(document.getElementById('y-offset')?.value || 0);
        const blendMode = document.getElementById('blend-mode')?.value || 'normal';

        // ËÆ°ÁÆóÊ∞¥Âç∞‰ΩçÁΩÆ
        const position = this.getWatermarkPosition();
        const x = position.x + xOffset;
        const y = position.y + yOffset;

        // ‰øùÂ≠òÂΩìÂâçÁä∂ÊÄÅ
        this.ctx.save();

        // ËÆæÁΩÆÈÄèÊòéÂ∫¶ÂíåÊ∑∑ÂêàÊ®°Âºè
        this.ctx.globalAlpha = opacity;
        this.ctx.globalCompositeOperation = blendMode;

        // ÁßªÂä®Âà∞Ê∞¥Âç∞‰ΩçÁΩÆ
        this.ctx.translate(x + (this.watermarkImage.width * scale) / 2, y + (this.watermarkImage.height * scale) / 2);

        // Â∫îÁî®ÊóãËΩ¨
        if (rotation !== 0) {
            this.ctx.rotate((rotation * Math.PI) / 180);
        }

        // Â∫îÁî®Áº©ÊîæÂπ∂ÁªòÂà∂Ê∞¥Âç∞
        this.ctx.scale(scale, scale);
        this.ctx.drawImage(this.watermarkImage, -this.watermarkImage.width / 2, -this.watermarkImage.height / 2);

        // ÊÅ¢Â§çÁä∂ÊÄÅ
        this.ctx.restore();
    },

    applyTextWatermark: function() {
        const text = document.getElementById('watermark-text')?.value || 'WATERMARK';
        const fontSize = parseFloat(document.getElementById('font-size')?.value || 36);
        const fontColor = document.getElementById('font-color')?.value || '#ffffff';
        const fontFamily = document.getElementById('font-family')?.value || 'Arial';
        const opacity = parseFloat(document.getElementById('opacity')?.value || 50) / 100;
        const rotation = parseFloat(document.getElementById('rotation')?.value || 0);
        const xOffset = parseFloat(document.getElementById('x-offset')?.value || 0);
        const yOffset = parseFloat(document.getElementById('y-offset')?.value || 0);
        const blendMode = document.getElementById('blend-mode')?.value || 'normal';

        // ËÆæÁΩÆÂ≠ó‰Ωì
        this.ctx.font = `${fontSize}px ${fontFamily}`;
        this.ctx.fillStyle = fontColor;
        this.ctx.textAlign = 'center';
        this.ctx.textBaseline = 'middle';

        // ËÆ°ÁÆóÊñáÂ≠ó‰ΩçÁΩÆ
        const position = this.getWatermarkPosition();
        const x = position.x + xOffset;
        const y = position.y + yOffset;

        // ‰øùÂ≠òÂΩìÂâçÁä∂ÊÄÅ
        this.ctx.save();

        // ËÆæÁΩÆÈÄèÊòéÂ∫¶ÂíåÊ∑∑ÂêàÊ®°Âºè
        this.ctx.globalAlpha = opacity;
        this.ctx.globalCompositeOperation = blendMode;

        // ÁßªÂä®Âà∞ÊñáÂ≠ó‰ΩçÁΩÆ
        this.ctx.translate(x, y);

        // Â∫îÁî®ÊóãËΩ¨
        if (rotation !== 0) {
            this.ctx.rotate((rotation * Math.PI) / 180);
        }

        // ÁªòÂà∂ÊñáÂ≠ó
        this.ctx.fillText(text, 0, 0);

        // ÊÅ¢Â§çÁä∂ÊÄÅ
        this.ctx.restore();
    },

    getWatermarkPosition: function() {
        const activePositionBtn = document.querySelector('.position-btn.active');
        const position = activePositionBtn?.dataset.position || 'center';

        const canvasWidth = this.canvas.width;
        const canvasHeight = this.canvas.height;

        // ‰º∞ÁÆóÊ∞¥Âç∞Â∞∫ÂØ∏
        let watermarkWidth, watermarkHeight;

        if (this.watermarkImage) {
            const scale = parseFloat(document.getElementById('scale')?.value || 100) / 100;
            watermarkWidth = this.watermarkImage.width * scale;
            watermarkHeight = this.watermarkImage.height * scale;
        } else {
            // ÊñáÂ≠óÊ∞¥Âç∞ÁöÑ‰º∞ÁÆóÂ∞∫ÂØ∏
            const fontSize = parseFloat(document.getElementById('font-size')?.value || 36);
            const text = document.getElementById('watermark-text')?.value || 'WATERMARK';
            watermarkWidth = text.length * fontSize * 0.6; // Á≤óÁï•‰º∞ÁÆó
            watermarkHeight = fontSize;
        }

        let x, y;

        switch(position) {
            case 'top-left':
                x = watermarkWidth / 2;
                y = watermarkHeight / 2;
                break;
            case 'top-center':
                x = canvasWidth / 2;
                y = watermarkHeight / 2;
                break;
            case 'top-right':
                x = canvasWidth - watermarkWidth / 2;
                y = watermarkHeight / 2;
                break;
            case 'center-left':
                x = watermarkWidth / 2;
                y = canvasHeight / 2;
                break;
            case 'center':
                x = canvasWidth / 2;
                y = canvasHeight / 2;
                break;
            case 'center-right':
                x = canvasWidth - watermarkWidth / 2;
                y = canvasHeight / 2;
                break;
            case 'bottom-left':
                x = watermarkWidth / 2;
                y = canvasHeight - watermarkHeight / 2;
                break;
            case 'bottom-center':
                x = canvasWidth / 2;
                y = canvasHeight - watermarkHeight / 2;
                break;
            case 'bottom-right':
                x = canvasWidth - watermarkWidth / 2;
                y = canvasHeight - watermarkHeight / 2;
                break;
            default:
                x = canvasWidth / 2;
                y = canvasHeight / 2;
        }

        return { x, y };
    },

    applyWatermark: function() {
        this.updateWatermark();
    },
    
    previewWatermark: function() {
        this.updateWatermark();
    },

    downloadResult: function() {
        if (!this.canvas) return;

        // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
        const link = document.createElement('a');
        link.download = 'watermarked_image.png';
        link.href = this.canvas.toDataURL('image/png');

        // Ëß¶Âèë‰∏ãËΩΩ
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    },

    loadNewImage: function() {
        // ÈáçÁΩÆÊâÄÊúâÊéßÂà∂È°πÂà∞ÈªòËÆ§ÂÄº
        const controls = [
            { id: 'x-offset', value: 0 },
            { id: 'y-offset', value: 0 },
            { id: 'opacity', value: 50 },
            { id: 'scale', value: 100 },
            { id: 'rotation', value: 0 },
            { id: 'font-size', value: 36 },
            { id: 'watermark-text', value: 'WATERMARK' },
            { id: 'font-color', value: '#ffffff' },
            { id: 'font-family', value: 'Arial' },
            { id: 'blend-mode', value: 'normal' }
        ];

        controls.forEach(control => {
            const element = document.getElementById(control.id);
            if (element) {
                element.value = control.value;
                // Ëß¶Âèëinput‰∫ã‰ª∂Êù•Êõ¥Êñ∞ÊòæÁ§∫ÂÄº
                if (element.type === 'range' || element.type === 'text') {
                    element.dispatchEvent(new Event('input'));
                }
            }
        });

        // ÈáçÁΩÆ‰ΩçÁΩÆÊåâÈíÆ
        document.querySelectorAll('.position-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector('[data-position="center"]')?.classList.add('active');

        // ÈáçÁΩÆÊñá‰ª∂ËæìÂÖ•Ê°Ü
        const mainImageInput = document.getElementById('main-image-input');
        const watermarkImageInput = document.getElementById('watermark-image-input');

        if (mainImageInput) {
            mainImageInput.value = '';
            const newMainInput = mainImageInput.cloneNode(true);
            mainImageInput.parentNode.replaceChild(newMainInput, mainImageInput);
            newMainInput.addEventListener('change', (e) => this.handleMainImageUpload(e));
        }

        if (watermarkImageInput) {
            watermarkImageInput.value = '';
            const newWatermarkInput = watermarkImageInput.cloneNode(true);
            watermarkImageInput.parentNode.replaceChild(newWatermarkInput, watermarkImageInput);
            newWatermarkInput.addEventListener('change', (e) => this.handleWatermarkImageUpload(e));
        }

        // Ê∏ÖÈô§Ê∞¥Âç∞È¢ÑËßà
        const watermarkPreview = document.querySelector('.watermark-preview');
        if (watermarkPreview) {
            watermarkPreview.remove();
        }

        // ÊòæÁ§∫‰∏ä‰º†Âå∫ÂüüÔºåÈöêËóèÂ§ÑÁêÜÂå∫Âüü
        document.querySelector('.upload-section').classList.remove('d-none');
        document.getElementById('processing-section').classList.add('d-none');

        // Ê∏ÖÁêÜÂΩìÂâçÂõæÂÉè
        this.currentImage = null;
        this.watermarkImage = null;
        this.canvas = null;
        this.ctx = null;

        if (window.ImageLabUtils) {
            window.ImageLabUtils.showNotification('Â∑≤ÈáçÁΩÆÔºåÂèØ‰ª•‰∏ä‰º†Êñ∞ÂõæÂÉè', 'info');
        }
    },

    createTextWatermark: function() {
        // ÂàáÊç¢Âà∞ÊñáÂ≠óÊ†áÁ≠æÈ°µ
        this.switchTab('text');

        // Ê∏ÖÈô§ÂõæÂÉèÊ∞¥Âç∞Ôºå‰ΩøÁî®ÊñáÂ≠óÊ∞¥Âç∞
        this.watermarkImage = null;

        // ËÆæÁΩÆÈªòËÆ§ÊñáÂ≠óÊ∞¥Âç∞
        const watermarkText = document.getElementById('watermark-text');
        if (watermarkText && !watermarkText.value.trim()) {
            watermarkText.value = 'WATERMARK';
        }

        // Ê£ÄÊü•ÊòØÂê¶ÂèØ‰ª•ËøõÂÖ•Â§ÑÁêÜÁïåÈù¢
        this.checkReadyToProcess();

        if (window.ImageLabUtils) {
            window.ImageLabUtils.showNotification('Â∑≤ÂàáÊç¢Âà∞ÊñáÂ≠óÊ∞¥Âç∞Ê®°Âºè', 'info');
        }
    },

    createLogoWatermark: function() {
        // ÂàõÂª∫‰∏Ä‰∏™ÁÆÄÂçïÁöÑlogoÊ∞¥Âç∞
        const canvas = document.createElement('canvas');
        canvas.width = 120;
        canvas.height = 120;
        const ctx = canvas.getContext('2d');

        // ÂàõÂª∫Ê∏êÂèòËÉåÊôØ
        const gradient = ctx.createLinearGradient(0, 0, 120, 120);
        gradient.addColorStop(0, '#667eea');
        gradient.addColorStop(1, '#764ba2');

        // ÁªòÂà∂ÂúÜÂΩ¢logo
        ctx.beginPath();
        ctx.arc(60, 60, 50, 0, 2 * Math.PI);
        ctx.fillStyle = gradient;
        ctx.fill();

        // Ê∑ªÂä†ÊñáÂ≠ó
        ctx.fillStyle = 'white';
        ctx.font = 'bold 20px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('LOGO', 60, 60);

        // ËΩ¨Êç¢‰∏∫ÂõæÂÉèÂπ∂Â§ÑÁêÜÈÄèÊòéÂ∫¶
        const img = new Image();
        img.onload = () => {
            this.watermarkImage = this.processWatermarkTransparency(img);
            this.isTextWatermarkMode = false; // Ê∏ÖÈô§ÊñáÂ≠óÊ∞¥Âç∞Ê®°Âºè
            this.showWatermarkPreview(this.watermarkImage);

            // Ê£ÄÊü•ÊòØÂê¶ÂèØ‰ª•ËøõÂÖ•Â§ÑÁêÜÁïåÈù¢
            this.checkReadyToProcess();

            if (window.ImageLabUtils) {
                window.ImageLabUtils.showNotification('LogoÊ∞¥Âç∞Â∑≤ÂàõÂª∫', 'success');
            }
        };
        img.src = canvas.toDataURL('image/png');
    },

    processWatermarkTransparency: function(img) {
        // ÂàõÂª∫‰∏¥Êó∂ÁîªÂ∏ÉÂ§ÑÁêÜÊ∞¥Âç∞ÈÄèÊòéÂ∫¶
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = img.width;
        tempCanvas.height = img.height;
        const tempCtx = tempCanvas.getContext('2d');

        // ÁªòÂà∂ÂéüÂßãÊ∞¥Âç∞ÂõæÂÉè
        tempCtx.drawImage(img, 0, 0);

        // Ëé∑ÂèñÂõæÂÉèÊï∞ÊçÆ
        const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
        const data = imageData.data;

        // Ê£ÄÊµãËÉåÊôØËâ≤ÔºàÂÅáËÆæÂ∑¶‰∏äËßíÂÉèÁ¥†‰∏∫ËÉåÊôØËâ≤Ôºâ
        const bgR = data[0];
        const bgG = data[1];
        const bgB = data[2];

        // ËÆæÁΩÆÂÆπÂ∑ÆÂÄº
        const tolerance = 30;

        // Â∞ÜÁõ∏‰ººËÉåÊôØËâ≤ËÆæ‰∏∫ÈÄèÊòé
        for (let i = 0; i < data.length; i += 4) {
            const r = data[i];
            const g = data[i + 1];
            const b = data[i + 2];

            // ËÆ°ÁÆóÈ¢úËâ≤Â∑ÆÂºÇ
            const diff = Math.abs(r - bgR) + Math.abs(g - bgG) + Math.abs(b - bgB);

            if (diff < tolerance) {
                data[i + 3] = 0; // ËÆæ‰∏∫ÈÄèÊòé
            }
        }

        // Â∞ÜÂ§ÑÁêÜÂêéÁöÑÊï∞ÊçÆÊîæÂõûÁîªÂ∏É
        tempCtx.putImageData(imageData, 0, 0);

        // ÂàõÂª∫Êñ∞ÁöÑÂõæÂÉèÂØπË±°
        const processedImg = new Image();
        processedImg.src = tempCanvas.toDataURL('image/png');

        return processedImg;
    },

    showWatermarkPreview: function(watermarkImg) {
        // Âú®Ê∞¥Âç∞‰∏ä‰º†Âå∫ÂüüÊòæÁ§∫È¢ÑËßà
        const watermarkUploadArea = document.getElementById('watermark-upload-area');
        if (watermarkUploadArea) {
            // ÁßªÈô§Áé∞ÊúâÈ¢ÑËßà
            const existingPreview = watermarkUploadArea.querySelector('.watermark-preview');
            if (existingPreview) {
                existingPreview.remove();
            }

            // ÂàõÂª∫È¢ÑËßàÂÖÉÁ¥†
            const preview = document.createElement('div');
            preview.className = 'watermark-preview';
            preview.style.cssText = `
                margin-top: 1rem;
                text-align: center;
                padding: 1rem;
                background: rgba(255, 255, 255, 0.9);
                border-radius: 8px;
                border: 2px solid var(--primary-color);
            `;

            const previewImg = document.createElement('img');
            previewImg.src = watermarkImg.src;
            previewImg.style.cssText = `
                max-width: 100px;
                max-height: 100px;
                border-radius: 4px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            `;

            const previewText = document.createElement('p');
            previewText.textContent = 'Ê∞¥Âç∞È¢ÑËßàÔºàÂ∑≤Â§ÑÁêÜÈÄèÊòéÂ∫¶Ôºâ';
            previewText.style.cssText = `
                margin: 0.5rem 0 0 0;
                font-size: 0.8rem;
                color: var(--text-light);
            `;

            preview.appendChild(previewImg);
            preview.appendChild(previewText);
            watermarkUploadArea.appendChild(preview);
        }
    },

    cleanup: function() {
        // Ê∏ÖÁêÜËµÑÊ∫ê
        this.currentImage = null;
        this.watermarkImage = null;
        this.canvas = null;
        this.ctx = null;
        this.isTextWatermarkMode = false;
    }
};
