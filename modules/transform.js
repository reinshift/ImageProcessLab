// ÂõæÂÉèÂèòÊç¢Ê®°Âùó
window.ImageTransform = {
    container: null,
    currentImage: null,
    originalImageData: null,
    canvas: null,
    ctx: null,
    
    init: function(container) {
        this.container = container;
        this.render();
        this.setupEventListeners();
    },
    
    render: function() {
        this.container.innerHTML = `
            <div class="transform-workspace">
                <!-- ÂõæÂÉè‰∏ä‰º†Âå∫Âüü -->
                <div class="upload-section">
                    <div class="upload-area" id="upload-area">
                        <div class="upload-content">
                            <div class="upload-icon">üìÅ</div>
                            <h3>ÈÄâÊã©ÂõæÂÉèÊñá‰ª∂</h3>
                            <p>ÊîØÊåÅ JPG„ÄÅPNG„ÄÅGIF Ê†ºÂºè</p>
                            <input type="file" id="image-input" accept="image/*" style="display: none;">
                            <button class="upload-btn" onclick="document.getElementById('image-input').click()">
                                ÈÄâÊã©Êñá‰ª∂
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- ÂõæÂÉèÂ§ÑÁêÜÂå∫Âüü -->
                <div class="processing-section d-none" id="processing-section">
                    <!-- ÂõæÂÉèÊòæÁ§∫Âå∫Âüü -->
                    <div class="image-display">
                        <div class="image-container">
                            <h4>ÂéüÂßãÂõæÂÉè</h4>
                            <img id="original-image" class="preview-image" alt="ÂéüÂßãÂõæÂÉè">
                        </div>
                        <div class="image-container">
                            <h4>Â§ÑÁêÜÁªìÊûú</h4>
                            <canvas id="result-canvas" class="preview-image"></canvas>
                        </div>
                    </div>

                    <!-- ÊµÆÂä®ÊéßÂà∂Èù¢Êùø -->
                    <div class="floating-control-panel" id="floating-control-panel">
                        <div class="panel-header" id="panel-header">
                            <div class="panel-title">
                                <span class="panel-icon">üéõÔ∏è</span>
                                <span>ÊéßÂà∂Èù¢Êùø</span>
                            </div>
                            <div class="panel-actions">
                                <button class="panel-btn minimize-btn" id="minimize-btn" title="ÊúÄÂ∞èÂåñ">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <line x1="5" y1="12" x2="19" y2="12"></line>
                                    </svg>
                                </button>

                                <button class="panel-btn close-btn" id="close-btn" title="ÂÖ≥Èó≠Èù¢Êùø">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="panel-content" id="panel-content">
                            <div class="control-panel">
                        <div class="control-tabs">
                            <button class="tab-btn active" data-tab="basic">Âü∫Á°ÄÂèòÊç¢</button>
                            <button class="tab-btn" data-tab="color">Ëâ≤ÂΩ©Ë∞ÉËäÇ</button>
                            <button class="tab-btn" data-tab="geometry">Âá†‰ΩïÂèòÊç¢</button>
                        </div>
                        
                        <!-- Âü∫Á°ÄÂèòÊç¢ -->
                        <div class="tab-content active" id="basic-tab">
                            <div class="control-group">
                                <button class="transform-btn" data-action="grayscale">ËΩ¨‰∏∫ÁÅ∞Â∫¶</button>
                                <button class="transform-btn" data-action="reset">ÈáçÁΩÆ</button>
                            </div>
                        </div>
                        
                        <!-- Ëâ≤ÂΩ©Ë∞ÉËäÇ -->
                        <div class="tab-content" id="color-tab">
                            <div class="color-section">
                                <h5>RGB ÈÄöÈÅìË∞ÉËäÇ</h5>
                                <div class="control-group">
                                    <label>Á∫¢Ëâ≤ÈÄöÈÅì</label>
                                    <input type="range" id="red-slider" min="0" max="200" value="100" class="color-slider">
                                    <span id="red-value">100%</span>
                                </div>
                                <div class="control-group">
                                    <label>ÁªøËâ≤ÈÄöÈÅì</label>
                                    <input type="range" id="green-slider" min="0" max="200" value="100" class="color-slider">
                                    <span id="green-value">100%</span>
                                </div>
                                <div class="control-group">
                                    <label>ËìùËâ≤ÈÄöÈÅì</label>
                                    <input type="range" id="blue-slider" min="0" max="200" value="100" class="color-slider">
                                    <span id="blue-value">100%</span>
                                </div>
                            </div>

                            <div class="color-section">
                                <h5>HSV Ë∞ÉËäÇ</h5>
                                <div class="control-group">
                                    <label>Ëâ≤Áõ∏ (H)</label>
                                    <input type="range" id="hue-slider" min="-180" max="180" value="0" class="color-slider">
                                    <span id="hue-value">0¬∞</span>
                                </div>
                                <div class="control-group">
                                    <label>È•±ÂíåÂ∫¶ (S)</label>
                                    <input type="range" id="saturation-slider" min="0" max="200" value="100" class="color-slider">
                                    <span id="saturation-value">100%</span>
                                </div>
                                <div class="control-group">
                                    <label>ÊòéÂ∫¶ (V)</label>
                                    <input type="range" id="value-slider" min="0" max="200" value="100" class="color-slider">
                                    <span id="value-value">100%</span>
                                </div>
                            </div>

                            <div class="color-section">
                                <h5>ÂÖ∂‰ªñË∞ÉËäÇ</h5>
                                <div class="control-group">
                                    <label>ÂØπÊØîÂ∫¶</label>
                                    <input type="range" id="contrast-slider" min="50" max="200" value="100" class="color-slider">
                                    <span id="contrast-value">100%</span>
                                </div>
                                <div class="control-group">
                                    <label>‰∫ÆÂ∫¶</label>
                                    <input type="range" id="brightness-slider" min="0" max="200" value="100" class="color-slider">
                                    <span id="brightness-value">100%</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Âá†‰ΩïÂèòÊç¢ -->
                        <div class="tab-content" id="geometry-tab">
                            <div class="geometry-section">
                                <h5>ÊóãËΩ¨ÂíåÁº©Êîæ</h5>
                                <div class="control-group">
                                    <label>ÊóãËΩ¨ËßíÂ∫¶</label>
                                    <input type="range" id="rotation-slider" min="0" max="360" value="0" class="geometry-slider">
                                    <span id="rotation-value">0¬∞</span>
                                </div>
                                <div class="control-group">
                                    <label>Áº©ÊîæÊØî‰æã</label>
                                    <input type="range" id="scale-slider" min="10" max="300" value="100" class="geometry-slider">
                                    <span id="scale-value">100%</span>
                                </div>
                            </div>

                            <div class="geometry-section">
                                <h5>Âπ≥Áßª</h5>
                                <div class="control-group">
                                    <label>Ê∞¥Âπ≥ÂÅèÁßª</label>
                                    <input type="range" id="translate-x" min="-200" max="200" value="0" class="geometry-slider">
                                    <span id="translate-x-value">0px</span>
                                </div>
                                <div class="control-group">
                                    <label>ÂûÇÁõ¥ÂÅèÁßª</label>
                                    <input type="range" id="translate-y" min="-200" max="200" value="0" class="geometry-slider">
                                    <span id="translate-y-value">0px</span>
                                </div>
                            </div>

                            <div class="geometry-section">
                                <h5>ÈïúÂÉèÊìç‰Ωú</h5>
                                <div class="control-group">
                                    <button class="transform-btn" data-action="flip-horizontal">Ê∞¥Âπ≥ÈïúÂÉè</button>
                                    <button class="transform-btn" data-action="flip-vertical">ÂûÇÁõ¥ÈïúÂÉè</button>
                                    <button class="transform-btn" data-action="rotate-90">È°∫Êó∂Èíà90¬∞</button>
                                    <button class="transform-btn" data-action="rotate-180">ÊóãËΩ¨180¬∞</button>
                                    <button class="transform-btn secondary" data-action="reset-geometry">ÈáçÁΩÆÈïúÂÉè</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Êìç‰ΩúÊåâÈíÆ -->
                        <div class="action-buttons">
                            <button class="action-btn secondary" id="download-btn">‰∏ãËΩΩÁªìÊûú</button>
                            <button class="action-btn primary" id="new-image-btn">Â§ÑÁêÜÊñ∞ÂõæÂÉè</button>
                        </div>
                            </div>
                        </div>

                        <!-- Áº©ÊîæÊâãÊüÑ -->
                        <div class="resize-handle n" data-direction="n"></div>
                        <div class="resize-handle s" data-direction="s"></div>
                        <div class="resize-handle w" data-direction="w"></div>
                        <div class="resize-handle e" data-direction="e"></div>
                        <div class="resize-handle nw" data-direction="nw"></div>
                        <div class="resize-handle ne" data-direction="ne"></div>
                        <div class="resize-handle sw" data-direction="sw"></div>
                        <div class="resize-handle se" data-direction="se"></div>
                    </div>

                    <!-- ÊéßÂà∂Èù¢ÊùøÂàáÊç¢ÊåâÈíÆ -->
                    <div class="panel-toggle-area">
                        <button class="panel-toggle-btn" id="panel-toggle-btn" style="display: none;">
                            <span class="toggle-icon">üéõÔ∏è</span>
                            <span class="toggle-text">ÊòæÁ§∫ÊéßÂà∂Èù¢Êùø</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <style>
                .transform-workspace {
                    max-width: 1200px;
                    margin: 0 auto;
                    position: relative;
                }

                .upload-section {
                    margin-bottom: 2rem;
                }

                .upload-area {
                    border: 2px dashed var(--border-color);
                    border-radius: 12px;
                    padding: 3rem 2rem;
                    text-align: center;
                    transition: all 0.3s ease;
                    cursor: pointer;
                }

                .upload-area:hover {
                    border-color: var(--primary-color);
                    background: rgba(102, 126, 234, 0.05);
                }

                .upload-icon {
                    font-size: 3rem;
                    margin-bottom: 1rem;
                }

                /* ÂõæÂÉèÊòæÁ§∫Âå∫Âüü */
                .image-display {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 2rem;
                    margin-bottom: 2rem;
                }

                /* ÊµÆÂä®ÊéßÂà∂Èù¢Êùø */
                .floating-control-panel {
                    position: fixed;
                    top: 120px;
                    right: 20px;
                    width: 380px;
                    height: 500px;
                    background: var(--background-white);
                    border-radius: 16px;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
                    border: 2px solid var(--border-color);
                    z-index: 1000;
                    transition: box-shadow 0.3s ease;
                    backdrop-filter: blur(10px);
                    overflow: hidden;
                    min-width: 280px;
                    min-height: 300px;
                    max-width: 800px;
                    max-height: calc(100vh - 40px);
                    display: flex;
                    flex-direction: column;
                }

                .floating-control-panel.minimized {
                    height: 50px;
                    overflow: hidden;
                }

                .floating-control-panel.hidden {
                    transform: translateX(100%);
                    opacity: 0;
                    pointer-events: none;
                }

                .floating-control-panel.resizing {
                    transition: none;
                    user-select: none;
                }

                /* Áº©ÊîæÊâãÊüÑ */
                .resize-handle {
                    position: absolute;
                    background: transparent;
                    z-index: 10;
                }

                .resize-handle.n {
                    top: -3px;
                    left: 10px;
                    right: 10px;
                    height: 6px;
                    cursor: n-resize;
                }

                .resize-handle.s {
                    bottom: -3px;
                    left: 10px;
                    right: 10px;
                    height: 6px;
                    cursor: s-resize;
                }

                .resize-handle.w {
                    left: -3px;
                    top: 10px;
                    bottom: 10px;
                    width: 6px;
                    cursor: w-resize;
                }

                .resize-handle.e {
                    right: -3px;
                    top: 10px;
                    bottom: 10px;
                    width: 6px;
                    cursor: e-resize;
                }

                .resize-handle.nw {
                    top: -3px;
                    left: -3px;
                    width: 12px;
                    height: 12px;
                    cursor: nw-resize;
                }

                .resize-handle.ne {
                    top: -3px;
                    right: -3px;
                    width: 12px;
                    height: 12px;
                    cursor: ne-resize;
                }

                .resize-handle.sw {
                    bottom: -3px;
                    left: -3px;
                    width: 12px;
                    height: 12px;
                    cursor: sw-resize;
                }

                .resize-handle.se {
                    bottom: -3px;
                    right: -3px;
                    width: 12px;
                    height: 12px;
                    cursor: se-resize;
                }

                .resize-handle:hover {
                    background: rgba(102, 126, 234, 0.3);
                }

                .panel-header {
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    padding: 12px 16px;
                    background: var(--primary-color);
                    color: white;
                    border-radius: 16px 16px 0 0;
                    cursor: move;
                    user-select: none;
                    flex-shrink: 0; /* Èò≤Ê≠¢Ê†áÈ¢òÊ†èË¢´ÂéãÁº© */
                }

                .panel-title {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    font-weight: 600;
                    font-size: 14px;
                }

                .panel-icon {
                    font-size: 16px;
                }

                .panel-actions {
                    display: flex;
                    gap: 4px;
                }

                .panel-btn {
                    width: 24px;
                    height: 24px;
                    border: none;
                    background: rgba(255, 255, 255, 0.2);
                    color: white;
                    border-radius: 4px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: background 0.2s ease;
                }

                .panel-btn:hover {
                    background: rgba(255, 255, 255, 0.3);
                }

                .panel-content {
                    flex: 1;
                    overflow-y: auto;
                    padding: 0;
                    min-height: 0; /* ÈáçË¶ÅÔºöÂÖÅËÆ∏flexÂ≠êÂÖÉÁ¥†Áº©Â∞è */
                }

                /* ÊéßÂà∂Èù¢ÊùøÂàáÊç¢ÊåâÈíÆ */
                .panel-toggle-area {
                    position: fixed;
                    top: 120px;
                    right: 20px;
                    z-index: 999;
                }

                .panel-toggle-btn {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    padding: 12px 16px;
                    background: var(--primary-color);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
                    transition: all 0.3s ease;
                    font-size: 14px;
                    font-weight: 500;
                }

                .panel-toggle-btn:hover {
                    background: var(--primary-hover);
                    transform: translateY(-2px);
                    box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
                }

                .toggle-icon {
                    font-size: 16px;
                }

                .upload-btn {
                    padding: 0.75rem 2rem;
                    background: var(--primary-color);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    margin-top: 1rem;
                }
                

                
                .image-container {
                    text-align: center;
                }
                
                .image-container h4 {
                    margin-bottom: 1rem;
                    color: var(--text-color);
                }
                
                .preview-image {
                    max-width: 100%;
                    max-height: 300px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                }
                
                .control-panel {
                    background: transparent;
                    border-radius: 0;
                    padding: 16px;
                }
                
                .control-tabs {
                    display: flex;
                    margin-bottom: 1.5rem;
                    border-bottom: 1px solid var(--border-color);
                }
                
                .tab-btn {
                    padding: 0.75rem 1.5rem;
                    background: none;
                    border: none;
                    cursor: pointer;
                    border-bottom: 2px solid transparent;
                    transition: all 0.3s ease;
                }
                
                .tab-btn.active {
                    color: var(--primary-color);
                    border-bottom-color: var(--primary-color);
                }
                
                .tab-content {
                    display: none;
                }
                
                .tab-content.active {
                    display: block;
                }
                
                .control-group {
                    margin-bottom: 1.5rem;
                    display: flex;
                    align-items: center;
                    gap: 1rem;
                }
                
                .control-group label {
                    min-width: 80px;
                    font-weight: 500;
                }

                .color-slider, .geometry-slider {
                    flex: 1;
                    margin: 0 1rem;
                }

                .color-section {
                    margin-bottom: 2rem;
                    padding: 1rem;
                    background: white;
                    border-radius: 8px;
                    border-left: 4px solid var(--primary-color);
                }

                .color-section h5 {
                    margin-bottom: 1rem;
                    color: var(--text-color);
                    font-size: 1rem;
                    font-weight: 600;
                }

                .geometry-section {
                    margin-bottom: 2rem;
                    padding: 1rem;
                    background: white;
                    border-radius: 8px;
                    border-left: 4px solid var(--secondary-color);
                }

                .geometry-section h5 {
                    margin-bottom: 1rem;
                    color: var(--text-color);
                    font-size: 1rem;
                    font-weight: 600;
                }
                
                .transform-btn {
                    padding: 0.5rem 1rem;
                    background: var(--primary-color);
                    color: white;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    margin-right: 0.5rem;
                    margin-bottom: 0.5rem;
                    transition: all 0.3s ease;
                }

                .transform-btn:hover {
                    background: var(--primary-hover);
                    transform: translateY(-1px);
                }

                .transform-btn.secondary {
                    background: var(--background-light);
                    color: var(--text-color);
                    border: 1px solid var(--border-color);
                }

                .transform-btn.secondary:hover {
                    background: var(--border-color);
                    border-color: var(--primary-color);
                    color: var(--primary-color);
                }
                
                .action-buttons {
                    display: flex;
                    gap: 1rem;
                    margin-top: 2rem;
                    padding-top: 1.5rem;
                    border-top: 1px solid var(--border-color);
                }
                
                .action-btn {
                    flex: 1;
                    padding: 0.75rem;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    font-weight: 500;
                }
                
                .action-btn.primary {
                    background: var(--primary-color);
                    color: white;
                }
                
                .action-btn.secondary {
                    background: var(--background-light);
                    color: var(--text-color);
                    border: 1px solid var(--border-color);
                }
                
                @media (max-width: 768px) {
                    .image-display {
                        grid-template-columns: 1fr;
                    }

                    .floating-control-panel {
                        position: fixed;
                        top: 80px;
                        left: 10px;
                        right: 10px;
                        width: auto;
                        max-height: calc(100vh - 100px);
                    }

                    .panel-toggle-area {
                        top: 80px;
                        right: 10px;
                    }

                    .control-group {
                        flex-direction: column;
                        align-items: stretch;
                    }

                    .action-buttons {
                        flex-direction: column;
                    }
                }

                /* ÊªöÂä®Êù°Ê†∑Âºè */
                .panel-content::-webkit-scrollbar {
                    width: 8px;
                }

                .panel-content::-webkit-scrollbar-track {
                    background: rgba(0, 0, 0, 0.05);
                    border-radius: 4px;
                    margin: 4px 0;
                }

                .panel-content::-webkit-scrollbar-thumb {
                    background: var(--border-color);
                    border-radius: 4px;
                    transition: background 0.2s ease;
                }

                .panel-content::-webkit-scrollbar-thumb:hover {
                    background: var(--primary-color);
                }

                /* Á°Æ‰øùÂÜÖÂÆπÊúâÈÄÇÂΩìÁöÑÂÜÖËæπË∑ùÔºåÈÅøÂÖç‰∏éÊªöÂä®Êù°ÈáçÂè† */
                .control-panel {
                    padding-right: 12px;
                }

                /* Ê∑±Ëâ≤‰∏ªÈ¢òÊîØÊåÅ */
                [data-theme="dark"] .floating-control-panel {
                    background: var(--background-white);
                    border-color: var(--border-color);
                }

                [data-theme="dark"] .panel-content::-webkit-scrollbar-track {
                    background: var(--background-light);
                }

                /* ÊãñÊãΩÊó∂ÁöÑÊ†∑Âºè */
                .floating-control-panel.dragging {
                    transition: none;
                    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.25);
                    transform: scale(1.02);
                }
            </style>
        `;
    },
    
    setupEventListeners: function() {
        // Êñá‰ª∂‰∏ä‰º†
        const imageInput = document.getElementById('image-input');
        imageInput.addEventListener('change', (e) => this.handleImageUpload(e));
        
        // ÊãñÊãΩ‰∏ä‰º†
        const uploadArea = document.getElementById('upload-area');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = 'var(--primary-color)';
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.borderColor = 'var(--border-color)';
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = 'var(--border-color)';
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                this.loadImage(files[0]);
            }
        });
        
        // Ê†áÁ≠æÈ°µÂàáÊç¢
        const tabBtns = document.querySelectorAll('.tab-btn');
        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => this.switchTab(btn.dataset.tab));
        });
        
        // ÂèòÊç¢ÊåâÈíÆ
        const transformBtns = document.querySelectorAll('.transform-btn');
        transformBtns.forEach(btn => {
            btn.addEventListener('click', () => this.applyTransform(btn.dataset.action));
        });

        // È¢úËâ≤ÊªëÂùó‰∫ã‰ª∂ÁõëÂê¨Âô®
        this.setupColorSliders();

        // Êìç‰ΩúÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
        this.setupActionButtons();

        // ÊµÆÂä®Èù¢ÊùøÂäüËÉΩ
        this.setupFloatingPanel();
    },
    
    handleImageUpload: function(event) {
        const file = event.target.files[0];
        if (file) {
            this.loadImage(file);
        }
    },
    
    loadImage: function(file) {
        if (!window.ImageLabUtils.validateImageFile(file)) {
            return;
        }

        window.ImageLabUtils.showLoading(true, 'Âä†ËΩΩÂõæÂÉè‰∏≠...');

        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                this.currentImage = img;
                this.setupCanvas();
                this.showProcessingSection();
                window.ImageLabUtils.showLoading(false);
                window.ImageLabUtils.showNotification('ÂõæÂÉèÂä†ËΩΩÊàêÂäü', 'success');
            };
            img.onerror = () => {
                window.ImageLabUtils.showLoading(false);
                window.ImageLabUtils.showNotification('ÂõæÂÉèÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Êñá‰ª∂Ê†ºÂºè', 'error');
            };
            img.src = e.target.result;
        };
        reader.onerror = () => {
            window.ImageLabUtils.showLoading(false);
            window.ImageLabUtils.showNotification('Êñá‰ª∂ËØªÂèñÂ§±Ë¥•', 'error');
        };
        reader.readAsDataURL(file);
    },
    
    setupCanvas: function() {
        const originalImage = document.getElementById('original-image');
        const canvas = document.getElementById('result-canvas');
        
        originalImage.src = this.currentImage.src;
        
        this.canvas = canvas;
        this.ctx = canvas.getContext('2d');
        
        // ËÆæÁΩÆÁîªÂ∏ÉÂ∞∫ÂØ∏
        canvas.width = this.currentImage.width;
        canvas.height = this.currentImage.height;
        
        // ÁªòÂà∂ÂéüÂßãÂõæÂÉè
        this.ctx.drawImage(this.currentImage, 0, 0);
        
        // ‰øùÂ≠òÂéüÂßãÂõæÂÉèÊï∞ÊçÆ
        this.originalImageData = this.ctx.getImageData(0, 0, canvas.width, canvas.height);
    },
    
    showProcessingSection: function() {
        document.querySelector('.upload-section').classList.add('d-none');
        document.getElementById('processing-section').classList.remove('d-none');

        // ÊòæÁ§∫ÊªëÂùóÈáçÁΩÆÂäüËÉΩÊèêÁ§∫
        if (window.ImageLabUtils && window.ImageLabUtils.showSliderResetTip) {
            // Âª∂Ëøü1ÁßíÊòæÁ§∫ÔºåËÆ©Áî®Êà∑ÂÖàÁúãÂà∞ÁïåÈù¢
            setTimeout(() => {
                window.ImageLabUtils.showSliderResetTip();
            }, 1000);
        }
    },
    
    switchTab: function(tabName) {
        // Êõ¥Êñ∞Ê†áÁ≠æÊåâÈíÆÁä∂ÊÄÅ
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        
        // Êõ¥Êñ∞Ê†áÁ≠æÂÜÖÂÆπ
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.getElementById(`${tabName}-tab`).classList.add('active');
    },
    
    applyTransform: function(action) {
        switch(action) {
            case 'grayscale':
                this.applyGrayscale();
                break;
            case 'reset':
                this.resetImage();
                break;
            case 'flip-horizontal':
                this.flipHorizontal();
                break;
            case 'flip-vertical':
                this.flipVertical();
                break;
            case 'rotate-90':
                this.rotateImage(90);
                break;
            case 'rotate-180':
                this.rotateImage(180);
                break;
            case 'reset-geometry':
                this.resetGeometry();
                break;
        }
    },
    
    applyGrayscale: function() {
        const imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
        const data = imageData.data;
        
        for (let i = 0; i < data.length; i += 4) {
            const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
            data[i] = gray;     // Red
            data[i + 1] = gray; // Green
            data[i + 2] = gray; // Blue
        }
        
        this.ctx.putImageData(imageData, 0, 0);
    },
    
    resetImage: function() {
        this.ctx.putImageData(this.originalImageData, 0, 0);
    },

    resetGeometry: function() {
        // ÈáçÁΩÆÂà∞ÂéüÂßãÂõæÂÉèÁä∂ÊÄÅ
        this.ctx.putImageData(this.originalImageData, 0, 0);

        // ÈáçÁΩÆÂá†‰ΩïÂèòÊç¢Áõ∏ÂÖ≥ÁöÑÊªëÂùó
        const translateXSlider = document.getElementById('translate-x');
        const translateYSlider = document.getElementById('translate-y');
        const translateXValue = document.getElementById('translate-x-value');
        const translateYValue = document.getElementById('translate-y-value');

        if (translateXSlider) {
            translateXSlider.value = 0;
            translateXValue.textContent = '0px';
        }

        if (translateYSlider) {
            translateYSlider.value = 0;
            translateYValue.textContent = '0px';
        }

        // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
        if (window.ImageLabUtils) {
            window.ImageLabUtils.showNotification('ÈïúÂÉèÂíåÂá†‰ΩïÂèòÊç¢Â∑≤ÈáçÁΩÆ', 'success', 2000);
        }
    },
    
    flipHorizontal: function() {
        // ‰øùÂ≠òÂΩìÂâçÁîªÂ∏ÉÂÜÖÂÆπ
        const currentImageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);

        // Ê∏ÖÁ©∫ÁîªÂ∏É
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

        // ‰øùÂ≠òÂèòÊç¢Áä∂ÊÄÅ
        this.ctx.save();

        // Â∫îÁî®Ê∞¥Âπ≥ÈïúÂÉèÂèòÊç¢
        this.ctx.scale(-1, 1);
        this.ctx.translate(-this.canvas.width, 0);

        // ÂàõÂª∫‰∏¥Êó∂ÁîªÂ∏É
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = this.canvas.width;
        tempCanvas.height = this.canvas.height;
        const tempCtx = tempCanvas.getContext('2d');
        tempCtx.putImageData(currentImageData, 0, 0);

        // ÁªòÂà∂ÈïúÂÉèÂêéÁöÑÂõæÂÉè
        this.ctx.drawImage(tempCanvas, 0, 0);

        // ÊÅ¢Â§çÂèòÊç¢Áä∂ÊÄÅ
        this.ctx.restore();
    },

    flipVertical: function() {
        // ‰øùÂ≠òÂΩìÂâçÁîªÂ∏ÉÂÜÖÂÆπ
        const currentImageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);

        // Ê∏ÖÁ©∫ÁîªÂ∏É
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

        // ‰øùÂ≠òÂèòÊç¢Áä∂ÊÄÅ
        this.ctx.save();

        // Â∫îÁî®ÂûÇÁõ¥ÈïúÂÉèÂèòÊç¢
        this.ctx.scale(1, -1);
        this.ctx.translate(0, -this.canvas.height);

        // ÂàõÂª∫‰∏¥Êó∂ÁîªÂ∏É
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = this.canvas.width;
        tempCanvas.height = this.canvas.height;
        const tempCtx = tempCanvas.getContext('2d');
        tempCtx.putImageData(currentImageData, 0, 0);

        // ÁªòÂà∂ÈïúÂÉèÂêéÁöÑÂõæÂÉè
        this.ctx.drawImage(tempCanvas, 0, 0);

        // ÊÅ¢Â§çÂèòÊç¢Áä∂ÊÄÅ
        this.ctx.restore();
    },

    rotateImage: function(degrees) {
        // ‰øùÂ≠òÂΩìÂâçÁîªÂ∏ÉÂÜÖÂÆπ
        const currentImageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);

        // Ê∏ÖÁ©∫ÁîªÂ∏É
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

        // ‰øùÂ≠òÂèòÊç¢Áä∂ÊÄÅ
        this.ctx.save();

        // ÁßªÂä®Âà∞ÁîªÂ∏É‰∏≠ÂøÉ
        this.ctx.translate(this.canvas.width / 2, this.canvas.height / 2);

        // ÊóãËΩ¨
        this.ctx.rotate((degrees * Math.PI) / 180);

        // ÁßªÂõûÂéüÁÇπ
        this.ctx.translate(-this.canvas.width / 2, -this.canvas.height / 2);

        // ÂàõÂª∫‰∏¥Êó∂ÁîªÂ∏É
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = this.canvas.width;
        tempCanvas.height = this.canvas.height;
        const tempCtx = tempCanvas.getContext('2d');
        tempCtx.putImageData(currentImageData, 0, 0);

        // ÁªòÂà∂ÊóãËΩ¨ÂêéÁöÑÂõæÂÉè
        this.ctx.drawImage(tempCanvas, 0, 0);

        // ÊÅ¢Â§çÂèòÊç¢Áä∂ÊÄÅ
        this.ctx.restore();
    },
    
    setupColorSliders: function() {
        const sliders = [
            { id: 'red-slider', valueId: 'red-value', suffix: '%', defaultValue: 100 },
            { id: 'green-slider', valueId: 'green-value', suffix: '%', defaultValue: 100 },
            { id: 'blue-slider', valueId: 'blue-value', suffix: '%', defaultValue: 100 },
            { id: 'hue-slider', valueId: 'hue-value', suffix: '¬∞', defaultValue: 0 },
            { id: 'saturation-slider', valueId: 'saturation-value', suffix: '%', defaultValue: 100 },
            { id: 'value-slider', valueId: 'value-value', suffix: '%', defaultValue: 100 },
            { id: 'contrast-slider', valueId: 'contrast-value', suffix: '%', defaultValue: 100 },
            { id: 'brightness-slider', valueId: 'brightness-value', suffix: '%', defaultValue: 100 },
            { id: 'rotation-slider', valueId: 'rotation-value', suffix: '¬∞', defaultValue: 0 },
            { id: 'scale-slider', valueId: 'scale-value', suffix: '%', defaultValue: 100 },
            { id: 'translate-x', valueId: 'translate-x-value', suffix: 'px', defaultValue: 0 },
            { id: 'translate-y', valueId: 'translate-y-value', suffix: 'px', defaultValue: 0 }
        ];

        sliders.forEach(slider => {
            const sliderElement = document.getElementById(slider.id);
            const valueElement = document.getElementById(slider.valueId);

            if (sliderElement && valueElement) {
                sliderElement.addEventListener('input', () => {
                    valueElement.textContent = sliderElement.value + slider.suffix;
                });

                // ‰ΩøÁî®Èò≤ÊäñÂ§ÑÁêÜÂèòÊç¢Â∫îÁî®ÔºåÊèêÈ´òÊÄßËÉΩ
                const debouncedTransform = window.ImageLabUtils.debounce(() => {
                    this.applyAllTransformations();
                }, 100);

                sliderElement.addEventListener('input', debouncedTransform);

                // ÂèåÂáªÈáçÁΩÆÂäüËÉΩ - ÊªëÂùó
                sliderElement.addEventListener('dblclick', () => {
                    sliderElement.value = slider.defaultValue;
                    valueElement.textContent = slider.defaultValue + slider.suffix;
                    this.applyAllTransformations();

                    if (window.ImageLabUtils) {
                        window.ImageLabUtils.showNotification(
                            `${slider.id.replace('-', ' ')} Â∑≤ÈáçÁΩÆ`,
                            'info',
                            1500
                        );
                    }
                });

                // ÂèåÂáªÈáçÁΩÆÂäüËÉΩ - Ê†áÁ≠æ
                const labelElement = valueElement.parentElement.querySelector('label');
                if (labelElement) {
                    labelElement.style.cursor = 'pointer';
                    labelElement.title = 'ÂèåÂáªÈáçÁΩÆÂà∞ÈªòËÆ§ÂÄº';

                    labelElement.addEventListener('dblclick', () => {
                        sliderElement.value = slider.defaultValue;
                        valueElement.textContent = slider.defaultValue + slider.suffix;
                        this.applyAllTransformations();

                        if (window.ImageLabUtils) {
                            window.ImageLabUtils.showNotification(
                                `${labelElement.textContent} Â∑≤ÈáçÁΩÆ`,
                                'info',
                                1500
                            );
                        }
                    });
                }
            }
        });
    },

    applyAllTransformations: function() {
        if (!this.originalImageData) return;

        // ÂÖàÂ∫îÁî®È¢úËâ≤Ë∞ÉÊï¥
        this.applyColorAdjustments();

        // ÁÑ∂ÂêéÂ∫îÁî®Âá†‰ΩïÂèòÊç¢
        this.applyGeometryTransformations();
    },

    applyColorAdjustments: function() {
        if (!this.originalImageData) return;

        // Ëé∑ÂèñÊâÄÊúâÊªëÂùóÁöÑÂÄº
        const red = parseFloat(document.getElementById('red-slider')?.value || 100) / 100;
        const green = parseFloat(document.getElementById('green-slider')?.value || 100) / 100;
        const blue = parseFloat(document.getElementById('blue-slider')?.value || 100) / 100;
        const hue = parseFloat(document.getElementById('hue-slider')?.value || 0);
        const saturation = parseFloat(document.getElementById('saturation-slider')?.value || 100) / 100;
        const brightness = parseFloat(document.getElementById('value-slider')?.value || 100) / 100;
        const contrast = parseFloat(document.getElementById('contrast-slider')?.value || 100) / 100;
        const brightnessAdjust = parseFloat(document.getElementById('brightness-slider')?.value || 100) / 100;

        // Â§çÂà∂ÂéüÂßãÂõæÂÉèÊï∞ÊçÆ
        const imageData = new ImageData(
            new Uint8ClampedArray(this.originalImageData.data),
            this.originalImageData.width,
            this.originalImageData.height
        );

        const data = imageData.data;

        for (let i = 0; i < data.length; i += 4) {
            let r = data[i];
            let g = data[i + 1];
            let b = data[i + 2];

            // RGBË∞ÉËäÇ
            r *= red;
            g *= green;
            b *= blue;

            // ‰∫ÆÂ∫¶ÂíåÂØπÊØîÂ∫¶Ë∞ÉËäÇ
            r = ((r / 255 - 0.5) * contrast + 0.5) * 255 * brightnessAdjust;
            g = ((g / 255 - 0.5) * contrast + 0.5) * 255 * brightnessAdjust;
            b = ((b / 255 - 0.5) * contrast + 0.5) * 255 * brightnessAdjust;

            // HSVË∞ÉËäÇ
            if (hue !== 0 || saturation !== 1 || brightness !== 1) {
                const hsv = this.rgbToHsv(r, g, b);
                hsv.h = (hsv.h + hue + 360) % 360;
                hsv.s *= saturation;
                hsv.v *= brightness;

                const rgb = this.hsvToRgb(hsv.h, hsv.s, hsv.v);
                r = rgb.r;
                g = rgb.g;
                b = rgb.b;
            }

            // Á°Æ‰øùÂÄºÂú®ÊúâÊïàËåÉÂõ¥ÂÜÖ
            data[i] = Math.max(0, Math.min(255, r));
            data[i + 1] = Math.max(0, Math.min(255, g));
            data[i + 2] = Math.max(0, Math.min(255, b));
        }

        this.ctx.putImageData(imageData, 0, 0);
    },

    applyGeometryTransformations: function() {
        const rotation = parseFloat(document.getElementById('rotation-slider')?.value || 0);
        const scale = parseFloat(document.getElementById('scale-slider')?.value || 100) / 100;
        const translateX = parseFloat(document.getElementById('translate-x')?.value || 0);
        const translateY = parseFloat(document.getElementById('translate-y')?.value || 0);

        if (rotation === 0 && scale === 1 && translateX === 0 && translateY === 0) {
            return; // Ê≤°ÊúâÂá†‰ΩïÂèòÊç¢ÈúÄË¶ÅÂ∫îÁî®
        }

        // ‰øùÂ≠òÂΩìÂâçÁîªÂ∏ÉÂÜÖÂÆπ
        const currentImageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);

        // Ê∏ÖÁ©∫ÁîªÂ∏É
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

        // ‰øùÂ≠òÂΩìÂâçÂèòÊç¢Áä∂ÊÄÅ
        this.ctx.save();

        // ÁßªÂä®Âà∞ÁîªÂ∏É‰∏≠ÂøÉ
        this.ctx.translate(this.canvas.width / 2, this.canvas.height / 2);

        // Â∫îÁî®ÊóãËΩ¨
        if (rotation !== 0) {
            this.ctx.rotate((rotation * Math.PI) / 180);
        }

        // Â∫îÁî®Áº©Êîæ
        if (scale !== 1) {
            this.ctx.scale(scale, scale);
        }

        // Â∫îÁî®Âπ≥Áßª
        this.ctx.translate(translateX, translateY);

        // ÁßªÂõûÂéüÁÇπÂπ∂ÁªòÂà∂ÂõæÂÉè
        this.ctx.translate(-this.canvas.width / 2, -this.canvas.height / 2);

        // ÂàõÂª∫‰∏¥Êó∂ÁîªÂ∏ÉÊù•ÁªòÂà∂ÂΩìÂâçÂõæÂÉè
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = this.canvas.width;
        tempCanvas.height = this.canvas.height;
        const tempCtx = tempCanvas.getContext('2d');
        tempCtx.putImageData(currentImageData, 0, 0);

        // ÁªòÂà∂ÂèòÊç¢ÂêéÁöÑÂõæÂÉè
        this.ctx.drawImage(tempCanvas, 0, 0);

        // ÊÅ¢Â§çÂèòÊç¢Áä∂ÊÄÅ
        this.ctx.restore();
    },

    rgbToHsv: function(r, g, b) {
        r /= 255;
        g /= 255;
        b /= 255;

        const max = Math.max(r, g, b);
        const min = Math.min(r, g, b);
        const diff = max - min;

        let h = 0;
        let s = max === 0 ? 0 : diff / max;
        let v = max;

        if (diff !== 0) {
            switch (max) {
                case r:
                    h = ((g - b) / diff + (g < b ? 6 : 0)) / 6;
                    break;
                case g:
                    h = ((b - r) / diff + 2) / 6;
                    break;
                case b:
                    h = ((r - g) / diff + 4) / 6;
                    break;
            }
        }

        return { h: h * 360, s: s, v: v };
    },

    hsvToRgb: function(h, s, v) {
        h /= 360;
        const c = v * s;
        const x = c * (1 - Math.abs((h * 6) % 2 - 1));
        const m = v - c;

        let r = 0, g = 0, b = 0;

        if (h < 1/6) {
            r = c; g = x; b = 0;
        } else if (h < 2/6) {
            r = x; g = c; b = 0;
        } else if (h < 3/6) {
            r = 0; g = c; b = x;
        } else if (h < 4/6) {
            r = 0; g = x; b = c;
        } else if (h < 5/6) {
            r = x; g = 0; b = c;
        } else {
            r = c; g = 0; b = x;
        }

        return {
            r: (r + m) * 255,
            g: (g + m) * 255,
            b: (b + m) * 255
        };
    },

    setupActionButtons: function() {
        const downloadBtn = document.getElementById('download-btn');
        const newImageBtn = document.getElementById('new-image-btn');

        if (downloadBtn) {
            downloadBtn.addEventListener('click', () => this.downloadResult());
        }

        if (newImageBtn) {
            newImageBtn.addEventListener('click', () => this.loadNewImage());
        }
    },

    downloadResult: function() {
        if (!this.canvas) {
            window.ImageLabUtils.showNotification('Ê≤°ÊúâÂèØ‰∏ãËΩΩÁöÑÂõæÂÉè', 'warning');
            return;
        }

        try {
            // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
            const link = document.createElement('a');
            link.download = 'transformed_image.png';
            link.href = this.canvas.toDataURL('image/png');

            // Ëß¶Âèë‰∏ãËΩΩ
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            window.ImageLabUtils.showNotification('ÂõæÂÉè‰∏ãËΩΩÊàêÂäü', 'success');
        } catch (error) {
            console.error('‰∏ãËΩΩÂ§±Ë¥•:', error);
            window.ImageLabUtils.showNotification('‰∏ãËΩΩÂ§±Ë¥•ÔºåËØ∑ÈáçËØï', 'error');
        }
    },

    loadNewImage: function() {
        // ÈáçÁΩÆÊâÄÊúâÊªëÂùóÂà∞ÈªòËÆ§ÂÄº
        const sliders = [
            { id: 'red-slider', value: 100 },
            { id: 'green-slider', value: 100 },
            { id: 'blue-slider', value: 100 },
            { id: 'hue-slider', value: 0 },
            { id: 'saturation-slider', value: 100 },
            { id: 'value-slider', value: 100 },
            { id: 'contrast-slider', value: 100 },
            { id: 'brightness-slider', value: 100 },
            { id: 'rotation-slider', value: 0 },
            { id: 'scale-slider', value: 100 },
            { id: 'translate-x', value: 0 },
            { id: 'translate-y', value: 0 }
        ];

        sliders.forEach(slider => {
            const element = document.getElementById(slider.id);
            if (element) {
                element.value = slider.value;
                // Ëß¶Âèëinput‰∫ã‰ª∂Êù•Êõ¥Êñ∞ÊòæÁ§∫ÂÄº
                element.dispatchEvent(new Event('input'));
            }
        });

        // ÈáçÁΩÆÊñá‰ª∂ËæìÂÖ•Ê°Ü
        const imageInput = document.getElementById('image-input');
        if (imageInput) {
            imageInput.value = '';
            // ÁßªÈô§Âπ∂ÈáçÊñ∞Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®‰ª•Á°Æ‰øùÊ≠£Â∏∏Â∑•‰Ωú
            const newInput = imageInput.cloneNode(true);
            imageInput.parentNode.replaceChild(newInput, imageInput);

            // ÈáçÊñ∞ÁªëÂÆö‰∫ã‰ª∂ÁõëÂê¨Âô®
            newInput.addEventListener('change', (e) => this.handleImageUpload(e));
        }

        // ÊòæÁ§∫‰∏ä‰º†Âå∫ÂüüÔºåÈöêËóèÂ§ÑÁêÜÂå∫Âüü
        document.querySelector('.upload-section').classList.remove('d-none');
        document.getElementById('processing-section').classList.add('d-none');

        // Ê∏ÖÁêÜÂΩìÂâçÂõæÂÉè
        this.currentImage = null;
        this.originalImageData = null;
        this.canvas = null;
        this.ctx = null;

        if (window.ImageLabUtils) {
            window.ImageLabUtils.showNotification('Â∑≤ÈáçÁΩÆÔºåÂèØ‰ª•‰∏ä‰º†Êñ∞ÂõæÂÉè', 'info');
        }
    },

    setupFloatingPanel: function() {
        const panel = document.getElementById('floating-control-panel');
        const panelHeader = document.getElementById('panel-header');
        const minimizeBtn = document.getElementById('minimize-btn');
        const closeBtn = document.getElementById('close-btn');
        const toggleBtn = document.getElementById('panel-toggle-btn');

        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };

        // ÊãñÊãΩÂäüËÉΩ
        panelHeader.addEventListener('mousedown', (e) => {
            if (e.target.closest('.panel-btn')) return; // ‰∏çÂú®ÊåâÈíÆ‰∏äÊâçËÉΩÊãñÊãΩ

            isDragging = true;
            panel.classList.add('dragging');

            const rect = panel.getBoundingClientRect();
            dragOffset.x = e.clientX - rect.left;
            dragOffset.y = e.clientY - rect.top;

            document.addEventListener('mousemove', handleDrag);
            document.addEventListener('mouseup', handleDragEnd);
            e.preventDefault();
        });

        function handleDrag(e) {
            if (!isDragging) return;

            const x = e.clientX - dragOffset.x;
            const y = e.clientY - dragOffset.y;

            // ÈôêÂà∂Âú®ËßÜÁ™óÂÜÖ
            const maxX = window.innerWidth - panel.offsetWidth;
            const maxY = window.innerHeight - panel.offsetHeight;

            const constrainedX = Math.max(0, Math.min(x, maxX));
            const constrainedY = Math.max(0, Math.min(y, maxY));

            panel.style.left = constrainedX + 'px';
            panel.style.top = constrainedY + 'px';
            panel.style.right = 'auto'; // ÂèñÊ∂àrightÂÆö‰Ωç
        }

        function handleDragEnd() {
            isDragging = false;
            panel.classList.remove('dragging');
            document.removeEventListener('mousemove', handleDrag);
            document.removeEventListener('mouseup', handleDragEnd);
        }

        // ÊúÄÂ∞èÂåñÂäüËÉΩ
        minimizeBtn.addEventListener('click', () => {
            panel.classList.toggle('minimized');
            const isMinimized = panel.classList.contains('minimized');
            minimizeBtn.innerHTML = isMinimized ?
                '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>' :
                '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="5" y1="12" x2="19" y2="12"></line></svg>';
            minimizeBtn.title = isMinimized ? 'ËøòÂéü' : 'ÊúÄÂ∞èÂåñ';
        });

        // Áº©ÊîæÂäüËÉΩ
        this.setupResizeHandles(panel);

        // ÂÖ≥Èó≠ÂäüËÉΩ
        closeBtn.addEventListener('click', () => {
            panel.classList.add('hidden');
            toggleBtn.style.display = 'flex';
        });

        // ÊòæÁ§∫Èù¢ÊùøÂäüËÉΩ
        toggleBtn.addEventListener('click', () => {
            panel.classList.remove('hidden');
            toggleBtn.style.display = 'none';
        });

        // ÂèåÂáªÊ†áÈ¢òÊ†èÈáçÁΩÆ‰ΩçÁΩÆ
        panelHeader.addEventListener('dblclick', () => {
            panel.style.top = '120px';
            panel.style.right = '20px';
            panel.style.left = 'auto';
            if (window.ImageLabUtils) {
                window.ImageLabUtils.showNotification('Èù¢Êùø‰ΩçÁΩÆÂ∑≤ÈáçÁΩÆ', 'info', 1500);
            }
        });

        // Á™óÂè£Â§ßÂ∞èÊîπÂèòÊó∂Ë∞ÉÊï¥Èù¢Êùø‰ΩçÁΩÆ
        window.addEventListener('resize', () => {
            const rect = panel.getBoundingClientRect();
            if (rect.right > window.innerWidth || rect.bottom > window.innerHeight) {
                panel.style.top = '120px';
                panel.style.right = '20px';
                panel.style.left = 'auto';
            }
        });
    },

    setupResizeHandles: function(panel) {
        const resizeHandles = panel.querySelectorAll('.resize-handle');

        resizeHandles.forEach(handle => {
            handle.addEventListener('mousedown', (e) => {
                e.preventDefault();
                e.stopPropagation();

                const direction = handle.dataset.direction;
                const startX = e.clientX;
                const startY = e.clientY;
                const startWidth = parseInt(window.getComputedStyle(panel).width, 10);
                const startHeight = parseInt(window.getComputedStyle(panel).height, 10);
                const startLeft = panel.offsetLeft;
                const startTop = panel.offsetTop;

                panel.classList.add('resizing');

                const handleMouseMove = (e) => {
                    const deltaX = e.clientX - startX;
                    const deltaY = e.clientY - startY;

                    let newWidth = startWidth;
                    let newHeight = startHeight;
                    let newLeft = startLeft;
                    let newTop = startTop;

                    // Ê†πÊçÆÊñπÂêëË∞ÉÊï¥Â∞∫ÂØ∏Âíå‰ΩçÁΩÆ
                    if (direction.includes('e')) {
                        newWidth = Math.max(280, Math.min(800, startWidth + deltaX));
                    }
                    if (direction.includes('w')) {
                        newWidth = Math.max(280, Math.min(800, startWidth - deltaX));
                        newLeft = startLeft + (startWidth - newWidth);
                    }
                    if (direction.includes('s')) {
                        newHeight = Math.max(300, Math.min(window.innerHeight - 40, startHeight + deltaY));
                    }
                    if (direction.includes('n')) {
                        newHeight = Math.max(300, Math.min(window.innerHeight - 40, startHeight - deltaY));
                        newTop = startTop + (startHeight - newHeight);
                    }

                    // Á°Æ‰øùÈù¢Êùø‰∏ç‰ºöË∂ÖÂá∫Â±èÂπïËæπÁïå
                    newLeft = Math.max(0, Math.min(window.innerWidth - newWidth, newLeft));
                    newTop = Math.max(0, Math.min(window.innerHeight - newHeight, newTop));

                    panel.style.width = newWidth + 'px';
                    panel.style.height = newHeight + 'px';
                    panel.style.left = newLeft + 'px';
                    panel.style.top = newTop + 'px';
                    panel.style.right = 'auto';
                    panel.style.bottom = 'auto';
                };

                const handleMouseUp = () => {
                    panel.classList.remove('resizing');
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                };

                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
            });
        });
    },

    cleanup: function() {
        // Ê∏ÖÁêÜËµÑÊ∫ê
        this.currentImage = null;
        this.originalImageData = null;
        this.canvas = null;
        this.ctx = null;
    }
};
